{% extends "bootstrap/base.html" %}

{% block styles %}
<link rel="stylesheet"
      href="{{url_for('.static', filename='css/bootstrap.min.css')}}">
<link rel="stylesheet"
      href="{{url_for('.static', filename='css/ocupus.css')}}">
<link rel="stylesheet"
      href="{{url_for('.static', filename='css/nprogress.css')}}">
<link rel="stylesheet"
      href="{{url_for('.static', filename='css/font-awesome.min.css')}}">

{% endblock %}

{% block title %}ocupus - Camera Viewer{% endblock %}

{% block navbar %}
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">ocupus</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li class="connection-status"><div class="connection-text">No Connection</div><div class="fa fa-unlink fa-2x" style="color: white;"></div></li>
          </ul>
        </div>
      </div>
    </div>
{% endblock %}



{% block content %}
   <div class="container-fluid">
      <div class="row">
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
          <div id="alerts"></div>
          <div id="camera-panel" class="row">

          </div>
          <div class="row" id="log-data">
          <div class="panel panel-success"><div class="panel-heading">
                  <a data-toggle="collapse" data-parent="#log-data" href="#collapseOne">
          Log
        </a></div>
    <div id="collapseOne" class="panel-collapse collapse in">
      <div class="panel-body">
        Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad squid. 3 wolf moon officia aute, non cupidatat skateboard dolor brunch. Food truck quinoa nesciunt laborum eiusmod. Brunch 3 wolf moon tempor, sunt aliqua put a bird on it squid single-origin coffee nulla assumenda shoreditch et. Nihil anim keffiyeh helvetica, craft beer labore wes anderson cred nesciunt sapiente ea proident. Ad vegan excepteur butcher vice lomo. Leggings occaecat craft beer farm-to-table, raw denim aesthetic synth nesciunt you probably haven't heard of them accusamus labore sustainable VHS.
      </div>
    </div>
          </div>
          </div>
      </div>
    </div>
   </div>
    {% endblock %}

{% block scripts %}
<script src="{{url_for('.static', filename='js/jquery-2.1.0.min.js')}}"></script>
<script src="{{url_for('.static', filename='js/bootstrap.min.js')}}"></script>
<script src="{{url_for('.static', filename='js/nprogress.js')}}"></script>
<script src="{{url_for('.static', filename='js/jquery-ui-1.10.4.custom.min.js')}}"></script>
<script src="{{url_for('.static', filename='js/adapter.js')}}"></script>
<script src="{{url_for('.static', filename='js/ocupus.js')}}"></script>
<script>


<<<<<<< HEAD
$("#camera-panel").sortable({
    connectWith: "#camera-panel",
          handle: ".panel-heading"
      
    });

</script>

{% endblock %}
=======
function handleServerNotification(data) {
  var parsed = data.split(',');
  if (parseInt(parsed[2]) != 0)
    other_peers[parseInt(parsed[1])] = parsed[0];
}

var localConnections = {};

var haveOffer = false;
var didIt = false;

var remoteConn;
var lastPeerId;



function setBitRate(sdp, videoBitRate)
 {
  sdp = sdp.replace( /b=AS([^\r\n]+\r\n)/g , '');
  // Set audio bandwidth low until we can get rid of it totally
  sdp = sdp.replace( /a=mid:audio\r\n/g , 'a=mid:audio\r\nb=AS:10\r\n');
  // 256 kilobits per second
  sdp = sdp.replace( /a=mid:video\r\n/g , 'a=mid:video\r\nb=AS:' + videoBitRate + '\r\n');
  return sdp;
 }

function isGoodCandidate(conn) {
  if ($("#dofilter").checked) {
    return conn.search("172.17") != -1;
  }
  return true;
}

// From http://stackoverflow.com/questions/4197591/parsing-url-hash-fragment-identifier-with-javascript
function getHashParams() {

    var hashParams = {};
    var e,
        a = /\+/g,  // Regex for replacing addition symbol with a space
        r = /([^&;=]+)=?([^&;]*)/g,
        d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
        q = window.location.hash.substring(1);

    while (e = r.exec(q))
       hashParams[d(e[1])] = d(e[2]);

    return hashParams;
}

function handlePeerMessage(peer_id, data) {
  lastPeerId = peer_id;
  ++message_counter;

    if (data.search("offer") != -1) {
      var offerInfo = JSON.parse(data);
      var servers = null;
      haveOffer = true;

      var localPeerConnection = new RTCPeerConnection(servers);

      localPeerConnection.setRemoteDescription(new RTCSessionDescription(offerInfo));

      localPeerConnection.createAnswer(function (description) {
        localPeerConnection.setLocalDescription(description);
        description.sdp = setBitRate(description.sdp, 2048);
        sendToPeer(peer_id, JSON.stringify(description));
      }, null, sdpConstraints);
      localPeerConnection.onicecandidate = function (icb) {

        if (icb.candidate && isGoodCandidate(JSON.stringify(icb.candidate))) {
          setTimeout(50,sendToPeer(peer_id, JSON.stringify(icb.candidate)));
        }
};

      localPeerConnection.onaddstream = function gotRemoteStream(e){
        var vidid = "vid" + peer_id;
        $("#remoteviews").append("<fieldset><legend>" + other_peers[peer_id] + "</legend><video id='" + vidid + "' autoplay></video></fieldset>");
        attachMediaStream($("#" + vidid).get(0), e.stream);
      };

      localConnections[peer_id] = localPeerConnection;

    }  

    if (data.search("candidate") != -1 && isGoodCandidate(data)) {
      var candidateInfo = JSON.parse(data);
      var cand = new RTCIceCandidate(candidateInfo);

      localConnections[peer_id].addIceCandidate(new RTCIceCandidate(candidateInfo));

      didIt = true;
    } 
}

function GetIntHeader(r, name) {
  var val = r.getResponseHeader(name);
  return val != null && val.length ? parseInt(val) : -1;
}

function showError(status) {

}

function hangingGetCallback() {

    if (hangingGet.readyState != 4)
      return;
    if (hangingGet.status != 200) {
      showError(hangingGet.statusText);
      disconnect();
    } else {
      var peer_id = GetIntHeader(hangingGet, "Pragma");
      if (peer_id == my_id) {
        handleServerNotification(hangingGet.responseText);
      } else {
        handlePeerMessage(peer_id, hangingGet.responseText);
      }
    }

    if (hangingGet) {
      hangingGet.abort();
      hangingGet = null;
    }

    if (my_id != -1)
      window.setTimeout(startHangingGet, 0);
}

function startHangingGet() {
  try {
    hangingGet = new XMLHttpRequest();
    hangingGet.onreadystatechange = hangingGetCallback;
    hangingGet.ontimeout = onHangingGetTimeout;
    hangingGet.open("GET", server + "/wait?peer_id=" + my_id, true);
    hangingGet.send();  
  } catch (e) {
    showError(e.description);
  }
}

function onHangingGetTimeout() {
  showError("hanging get timeout. issuing again.");
  hangingGet.abort();
  hangingGet = null;
  if (my_id != -1)
    window.setTimeout(startHangingGet, 0);
}

function signInCallback() {
  try {
    if (request.readyState == 4) {
      if (request.status == 200) {
        var peers = request.responseText.split("\n");
        my_id = parseInt(peers[0].split(',')[1]);
        for (var i = 1; i < peers.length; ++i) {
          if (peers[i].length > 0) {
            var parsed = peers[i].split(',');
            other_peers[parseInt(parsed[1])] = parsed[0];
          }
        }
        startHangingGet();
        request = null;
      }
    }
  } catch (e) {
    showError("error: " + e.description);
  }
}

function signIn() {
  try {
    request = new XMLHttpRequest();
    request.onreadystatechange = signInCallback;
    request.open("GET", server + "/sign_in?" + localName, true);
    request.send();
  } catch (e) {
    showError("error: " + e.description);
  }
}

function sendToPeer(peer_id, data) {
  if (my_id == -1) {
    alert("Not connected");
    return;
  }
  if (peer_id == my_id) {
    alert("Can't send a message to oneself :)");
    return;
  }
  var r = new XMLHttpRequest();
  r.open("POST", server + "/message?peer_id=" + my_id + "&to=" + peer_id,
         false);
  r.setRequestHeader("Content-Type", "text/plain");
  r.send(data);
  r = null;
}

function connect() {
  localName = document.getElementById("local").value.toLowerCase();
  server = document.getElementById("server").value.toLowerCase();
  if (localName.length == 0) {
    alert("I need a name please.");
    document.getElementById("local").focus();
  } else {
    document.getElementById("connect").disabled = true;
    document.getElementById("disconnect").disabled = false;
    signIn();
  }
}

function disconnect() {
  if (request) {
    request.abort();
    request = null;
  }
  
  if (hangingGet) {
    hangingGet.abort();
    hangingGet = null;
  }

  if (my_id != -1) {
    request = new XMLHttpRequest();
    request.open("GET", server + "/sign_out?peer_id=" + my_id, false);
    request.send();
    request = null;
    my_id = -1;
  }

  document.getElementById("connect").disabled = false;
  document.getElementById("disconnect").disabled = true;
}

window.onbeforeunload = disconnect;

function send() {
  var text = document.getElementById("message").value;
  var peer_id = parseInt(document.getElementById("peer_id").value);
  if (!text.length || peer_id == 0) {
    alert("No text supplied or invalid peer id");
  } else {
    sendToPeer(peer_id, text);
  }
}

function toggleMe(obj) {
  var id = obj.id.replace("toggle", "msg");
  var t = document.getElementById(id);
  if (obj.innerText == "+") {
    obj.innerText = "-";
    t.style.display = "block";
  } else {
    obj.innerText = "+";
    t.style.display = "none";
  }
}

</script>

</head>
<body>
Server: <input type="text" id="server" value="http://172.17.0.1:8888" /><br>
Your name: <input type="text" id="local" value="receiver"/>
<button id="connect" onclick="connect();">Connect</button>
<button disabled="true" id="disconnect"
        onclick="disconnect();">Disconnect</button><br>
<input id="dofilter" type="checkbox" name="dofilter" value="dofilter">Restrict candidates to 172.17. for OpenVPN</input>
<br>

<pre id="debug">
</pre>
<br><hr>
<div id="remoteviews"></div>
</body>
<script>
$(document).ready(function() {
  var hashConf = getHashParams();
  if (typeof(hashConf['server']) !== 'undefined') {
    $("#server").attr("value",hashConf['server']);
  }

  if (typeof(hashConf['restrict']) !== 'undefined' && hashConf['restrict'] == "y") {
    $("#dofilter").prop('checked', true);
  }

  if (typeof(hashConf['auto']) !== 'undefined' && hashConf['auto'] == "y") {
    connect();
  }

  
});
</script>
</html>
>>>>>>> a835e536f16f57552f396a0b98c0ec97db3d580b
